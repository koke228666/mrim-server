# Описание протокола MRIM.[^1]
Дефолтный порт для незащищённого подключения **2042**, в ином случае **443**. Здесь описываестя имплементация только незащищённого соединения.

Из чего состоит пакет:
```c
typedef struct mrim_packet_header_t
{
    unsigned int  magic;		// Magic
    unsigned int  proto;		// Версия протокола
    unsigned int  seq;		// Sequence
    unsigned int  msg;		// Тип пакета
    unsigned int  dlen; 		// Длина данных
    unsigned int	from;		// Адрес отправителя
    unsigned int	fromport;	// Порт отправителя
    unsigned char	reserved[16];	// Зарезервировано
}
```
## Подключение
Официальные клиенты подключаются сначала к порту **2042**. Сервер должен отдать только айпи и порт в виде `127.0.0.1:2041`.

**Все значения MRIM_\* можно найти в Header-файлле proto.h.**[^2]

Происходит подключение к серверу по порту **2041**, после него сразу отправляется пакет `MRIM_CS_HELLO`. Сервер отправляет в ответ `MRIM_CS_HELLO_ACK` вместе с периодом пинга[^3]. Юзер отправляет "логин, пароль, информацию о клиенте, локаль"[^4], тип пакета `MRIM_CS_LOGIN3`.

После установки TCP-соединения клиент обязан сразу послать `MRIM_CS_HELLO`, дождаться `MRIM_CS_HELLO_ACK`, после чего отправить `MRIM_CS_PING` с установленным в `MRIM_CS_HELLO_ACK` интервалом.

В случае неудачи сервер отправляет `MRIM_CS_LOGIN_REJ` и причину string'ом.

В случае удачи `MRIM_CS_LOGIN_ACK` без данных.

## Подробное HEX-описание данных пакета
`MRIM_CS_CONTACT_LIST2 S -> C:`
```hex
00 00 00 00 						// GET_CONTACTS_OK
02 00 00 00 						// Количество групп (здесь 2)
02 00 00 00 75 73 					// Маска группы (us – UL и LPS)
0C 00 00 00 75 75 73 73 75 75 73 73 73 73 75 73    // Маска контакта (uussuussssuu)

08 00 00 00 						// Флаг группы
07 00 00 00 47 65 6E 65 72 61 6C 			// Имя группы в UTF-16LE

08 00 00 00 						// Флаг группы
04 00 00 00 54 65 73 74 				// Имя группы в UTF-16LE

08 00 00 00 						// Флаг контакта
01 00 00 00 						// В какой группе
0F 00 00 00 73 75 70 70 6F 72 74 40 6D 61 69 6C 2E 72 75 // Email контакта
07 00 00 00 53 6C 75 7A 68 62 61 			// Имя контакта в UTF-16LE
00 00 00 00 						// Серверные флаги (напр CONTACT_INTFLAG_NOT_AUTHORIZED)
01 00 00 00 						// статус
00 00 00 00 						// LPS: Номер телефона
00 00 00 00 						// LPS: xstatus - название статуса
00 00 00 00 						// LPS: xstatus - заголовок в UTF-16LE
00 00 00 00 						// LPS: xstatus - текст в UTF-16LE
FF 03 00 00 						// UL: ??? (всегда равен 0x03FF)
27 00 00 00 63 6C 69 65 6E 74 3D 4A 32 4D 45 41 67 65 6E 74 20 76 65 72 73 69 6F 6E 3D 31 2E 33 20 62 75 69 6C 64 3D 31 39 33 37		// LPS: описание клиента в формате client=name version=version build=1345
```

`MRIM_CS_MESSAGE C -> S:`
```hex
00 00 00 00 								// UL: флаг сообщения
0F 00 00 00 73 75 70 70 6F 72 74 40 6D 61 69 6C 2E 72 75 	// LPS: адресат
0D 00 00 00 74 65 73 74 74 65 73 74 74 65 73 74 20 		// текст
01 00 00 00 20							// текст в rtf
```

`MRIM_CS_MESSAGE_ACK C -> S:`
```hex
10 00 00 00 								// UL: уникальный номер
00 00 00 00 								// UL: флаг сообщения
0F 00 00 00 73 75 70 70 6F 72 74 40 6D 61 69 6C 2E 72 75 	// LPS: адресат
0D 00 00 00 74 65 73 74 74 65 73 74 74 65 73 74 20 		// текст
01 00 00 00 20							// текст в rtf
```
[^1]: Большинство взято из исходников протокола: https://storage.googleapis.com/google-code-archive-source/v2/code.google.com/myagent-im/source-archive.zip
[^2]: Или в самой документации Mail.Ru Агента в разделе "Типы пакетов": https://www.google.com/url?q=https://web.archive.org/web/20120801074750/http://help.mail.ru/agent-help/developers/description&sa=D&source=docs&ust=1719238942469216&usg=AOvVaw3T_O_qhEXg40ZXcyUMY01C
[^3]: Время, через которое клиент должен постоянно отправлять пинг серверу.
[^4]: См. MRIMClientPrivate::processHelloAck
